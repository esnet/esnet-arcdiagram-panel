define(["@grafana/data","react","@grafana/ui","d3"],((e,t,a,o)=>(()=>{"use strict";var n={305:t=>{t.exports=e},388:e=>{e.exports=a},200:e=>{e.exports=o},650:e=>{e.exports=t}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var a=r[e]={exports:{}};return n[e](a,a.exports,i),a.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var l={};return(()=>{i.r(l),i.d(l,{plugin:()=>k});var e=i(305),t=i(650),a=i.n(t),o=i(388),n=i(200);function r(e,t){return t.find((t=>t.id===e)).name}function s({id:e,links:t}){return t.filter((t=>t.source===e)).map((e=>e.target))}function d(e,t,a,o,n){const r=Math.log10(o),i=(a-1)/(Math.log10(n)-r);return(Math.log10(e)-r)*i+t}function c(e,t,a,o,n,r,i,l){o.strokeWidth=e?"log"===t?d(o.sum,n,r,i,l):o.sum/1e13:a}function u(e,t){var a;const o=e.getBoundingClientRect().width*(t?1.6:1),n=t?.2:.3,r=Number(null===(a=e.getAttribute("transform"))||void 0===a?void 0:a.split(",")[0].substring(10));if(o>r){const t=o-r;e.innerHTML="..."+e.innerHTML.substring(t*n,e.innerHTML.length)}}function p(e){e.innerHTML=e.getAttribute("name")}function m(e,t,a){let o=0,n=null;for(const e of t){const t=Math.abs(e.target-e.source)-1;t>o&&(o=t,n=e)}return(n.target-n.source)*((a-50-50)/(e.length-1))/2+3.77*e.reduce(((e,t)=>t.name.length>e.name.length?t:e)).name.length*1.6}const f={containerStyle:{width:"100%",height:"100%"},labelStyle:{width:"100%",height:"100%","z-index":"10"},buttonStyle:{width:"30px",height:"30px",top:0,position:"absolute"},toolTipStyle:{box:{position:"absolute",left:"",top:"",width:"auto",height:"auto",background:"white",padding:"1em",margin:"1em","max-width":"200px","border-radius":"5px",opacity:.9},text:{color:"black","font-size":"10px",margin:"0","font-weight":"100"},preface:{"font-weight":"900"}},panelContainerStyle:{height:"100%",width:"100%"},searchFieldStyle:{position:"absolute",top:0,right:0,padding:"1em"},inputStyle:e=>({width:"200px",height:"25px",background:e?"rgb(244 245 245 / 83%)":"hsla(0, 0%, 0%, 0.5)",color:e?"black":"white","border-radius":"5px"})};let g={source:"",target:a().createElement("p",null),sum:"",field:a().createElement("p",null),pos:[0,0]};const h=function(e){let o=e.parsedData.uniqueNodes,i=e.parsedData.links;const l=(0,t.useRef)(null),d=(0,t.useRef)(null),c=(0,t.useRef)(null),m=(0,t.useRef)(null),[h,y]=(0,t.useState)(!1),b=e=>{y(e)};function v(t,n,l,d,c){void 0===d?(g.source=r(l,o),g.target=s({id:l,links:i}).map((e=>r(e,o))).filter(((e,t,a)=>a.indexOf(e)===t)).map(((e,t)=>a().createElement("p",{style:f.toolTipStyle.text,key:t},e,a().createElement("br",null)))),g.sum="",g.field=a().createElement("p",null)):(g.source=r(l,o),g.target=a().createElement("p",{style:f.toolTipStyle.text},r(d,o)),g.sum=c,g.field=a().createElement("p",null,a().createElement("b",{style:f.toolTipStyle.preface},e.parsedData.additionalField),i.find((e=>e.source===l&&e.target===d)).field.map(((e,t)=>a().createElement("p",{style:f.toolTipStyle.text,key:t},e,a().createElement("br",null)))))),b(n);const u=document.querySelectorAll(`[data-panelid="${e.panelId}"] .panel-container`)[0];if(void 0!==u){const e=u.getBoundingClientRect();let a=t[1]-e.top,o=t[0]-e.left;const n=document.querySelectorAll(".tooltip")[0],r=n.getBoundingClientRect();let i="left";o+r.right>e.right&&(i="right",o=e.right-t[0]);let l="top";a+r.bottom-350>e.bottom&&(l="bottom",a=e.bottom-t[1]),"top"===l?n.style.top=`${a}px`:n.style.bottom=`${a}px`,"left"===i?n.style.left=`${o}px`:n.style.right=`${o}px`}}return(0,t.useEffect)((()=>{n.selectAll(`[data-panelid="${e.panelId}"] circle, [data-panelid="${e.panelId}"] path, [data-panelid="${e.panelId}"] text`).remove();const t=e.width,a=e.height,r=l.current,m=d.current,f=c.current;n.select(f).selectAll(`[data-panelid="${e.panelId}"] text`).data(o).enter().append("text").attr("x",(e=>o.find((t=>t.id===e.id)).radius>=5?-2*o.find((t=>t.id===e.id)).radius:-10)).attr("y",(e=>o.find((t=>t.id===e.id)).radius>=5?2*o.find((t=>t.id===e.id)).radius:10)).text(((e,t)=>o[t].name)).style("text-anchor","end").attr("fill",(()=>e.isDarkMode?"white":"black")).attr("font-size",10).attr("transform",((e,t)=>"translate(0,"+a+")rotate(-45)")).style("margin-right","5px").attr("name",((e,t)=>o[t].name)).attr("id",((e,t)=>t));let g=Math.max(...Array.from($("text"),(e=>e.getBoundingClientRect().height)));g*=1.6;const h=function(e,t,a){const o=(t-50)/(a-1);return Array.from({length:a},((e,t)=>50+t*o))}(0,t-50,o.length);n.selectAll(`[data-panelid="${e.panelId}"] text`).attr("transform",((e,t)=>"translate("+h[t]+","+(a-g)+")rotate(-45)"));const y=document.getElementsByTagName("text");Array.from(y).forEach((e=>{u(e,!1)})),e.graphOptions.search&&function(e,t,a){for(let o=0;o<a.length;o++)if(e){let n=t.map((({name:e,id:t})=>({name:e,id:t})));n=n.filter((t=>t.name.toLowerCase().includes(e.toLowerCase()))),n.map((e=>e.id)).includes(Number(a[o].id))?a[o].style.opacity="1":a[o].style.opacity="0.2"}else a[o].style.opacity="1"}(e.query,o,y),n.select(r).selectAll(`[data-panelid="${e.panelId}"] circle`).data(o).enter().append("circle").attr("cx",((e,t)=>h[t])).attr("cy",a-g).attr("r",(e=>null==e?void 0:e.radius)).style("fill",e.parsedData.hexColors.nodeColor).attr("id",((e,t)=>o[t].id)).attr("name",((e,t)=>o[t].name)).attr("radius",((e,t)=>o[t].radius)),n.select(m).selectAll(`[data-panelid="${e.panelId}"] path`).data(i).enter().append("path").attr("d",(function(e,t){const o=h[i[t].source],n=h[i[t].target];return["M",o,a-g,"A",(o-n)/2,",",(o-n)/2,0,0,",",o<n?1:0,n,",",a-g].join(" ")})).style("fill","none").attr("stroke",(e=>null==e?void 0:e.color)).attr("id","arc").attr("stroke-width",(e=>null==e?void 0:e.strokeWidth)).style("stroke-opacity",e.graphOptions.arcOpacity).attr("source",((e,t)=>i[t].source)).attr("target",((e,t)=>i[t].target)).attr("sum",((e,t)=>i[t].sum)).attr("displayValue",((e,t)=>i[t].displayValue));const S=n.selectAll(`[data-panelid="${e.panelId}"] circle`),x=n.selectAll(`[data-panelid="${e.panelId}"] path`),F=n.selectAll(`[data-panelid="${e.panelId}"] text`),C=200;S.on("mouseover",(function(t){v([t.clientX,t.clientY],!0,Number(t.srcElement.id)),y[t.srcElement.id].setAttribute("name",y[t.srcElement.id].innerHTML);const a=s({id:Number(t.srcElement.id),links:i});u(y[t.srcElement.id],!0),a.forEach((e=>{u(y[e],!0)})),S.style("opacity",(e=>a.includes(e.id)?1:.5)).transition().attr("r",(e=>a.includes(e.id)?2*o[e.id].radius:o[e.id].radius)).duration(C),n.select(this).style("opacity",1).transition().duration(C).attr("r",2*o[t.srcElement.id].radius),x.transition().style("stroke-opacity",(a=>t.srcElement.id==(null==a?void 0:a.source)?e.graphOptions.arcOpacity:.5*e.graphOptions.arcOpacity)).attr("stroke-width",(e=>t.srcElement.id==(null==e?void 0:e.source)?2*(null==e?void 0:e.strokeWidth):null==e?void 0:e.strokeWidth)).duration(C),F.transition().duration(C).attr("font-size",(e=>e.name===t.srcElement.getAttribute("name")||a.includes(e.id)?16:10)).style("opacity",(e=>e.name===t.srcElement.getAttribute("name")||a.includes(e.id)?1:.1))})).on("mouseout",(function(t){const a=s({id:Number(t.srcElement.id),links:i});p(y[t.srcElement.id]),a.forEach((e=>{p(y[e])})),b(!1),S.transition().duration(C).attr("r",(e=>o[e.id].radius)).style("opacity",1),n.select(this).transition().duration(C).attr("r",o[t.srcElement.id].radius),x.transition().duration(C).style("stroke-opacity",e.graphOptions.arcOpacity).attr("stroke-width",(e=>null==e?void 0:e.strokeWidth)),F.transition().duration(C).attr("font-size",10).style("opacity",1)})),x.on("mouseover",(function(t){v([t.clientX,t.clientY],!0,Number(t.srcElement.getAttribute("source")),Number(t.srcElement.getAttribute("target")),t.srcElement.getAttribute("displayValue")),x.style("opacity",.5*e.graphOptions.arcOpacity).transition().duration(C),n.select(this).transition().style("opacity",e.graphOptions.arcOpacity).duration(C)})).on("mouseout",(function(t){b(!1),x.style("opacity",e.graphOptions.arcOpacity).transition().duration(C),n.select(this).transition().style("opacity",e.graphOptions.arcOpacity).duration(C)}))}),[e.graphOptions,i,e.height,e.parsedData.hexColors.nodeColor,e.width,o]),a().createElement("div",{style:f.containerStyle},a().createElement("svg",{style:f.containerStyle,ref:l},a().createElement("g",{style:f.containerStyle,ref:d}),a().createElement("svg",{className:"text-container",style:f.labelStyle,ref:c})),h&&a().createElement("div",{ref:m,style:f.toolTipStyle.box,className:"tooltip"},a().createElement("p",{style:f.toolTipStyle.text},a().createElement("b",{style:f.toolTipStyle.preface},e.graphOptions.toolTipSource)," "," ",g.source),a().createElement("div",{style:f.toolTipStyle.text},a().createElement("b",{style:f.toolTipStyle.preface},e.graphOptions.toolTipTarget),g.target),a().createElement("p",{style:f.toolTipStyle.text},a().createElement("b",{style:f.toolTipStyle.preface},e.graphOptions.toolTipMetric)," ",g.sum),a().createElement("p",{style:f.toolTipStyle.text}," ",g.field)))};function y(e){return a().createElement("div",{style:f.searchFieldStyle},a().createElement("input",{style:f.inputStyle(e.isDarkMode),type:"text",name:"name",onChange:t=>{e.onQuery(t.target.value)}}))}function b(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const v=({value:e,onChange:n,item:r,suffix:i})=>{const l=(0,t.useCallback)((e=>{n(String(e))}),[n]);return a().createElement("div",null,a().createElement(o.RangeSlider,{min:1,max:50,onAfterChange:l,onChange:l,orientation:"horizontal",value:[1,15]}))};function S(e,t,a,o,n,r,i){try{var l=e[r](i),s=l.value}catch(e){return void a(e)}l.done?t(s):Promise.resolve(s).then(o,n)}function x(e){return function(){var t=this,a=arguments;return new Promise((function(o,n){var r=e.apply(t,a);function i(e){S(r,o,n,i,l,"next",e)}function l(e){S(r,o,n,i,l,"throw",e)}i(void 0)}))}}const F=["Appearance"],C=["Data"],k=new e.PanelPlugin((({options:e,data:n,width:r,height:i,id:l})=>{const[s,u]=(0,t.useState)("");let p=function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},o=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),o.forEach((function(t){b(e,t,a[t])}))}return e}({},e);const g=(0,o.useTheme2)();if(n.series[0].fields.length>3)return a().createElement("div",null,"4th group by not supported");if((e.src?n.series[0].fields.find((t=>t.name===e.src)).name:n.series[0].fields[0].name)===(e.dest?n.series[0].fields.find((t=>t.name===e.dest)).name:n.series[0].fields[1].name))return a().createElement("div",null,"Source equals target");let v={uniqueNodes:[],links:[]};try{v=function(e,t,a){var o,n,r,i,l,s;const u=e.series[0].fields,p=t.src?u.find((e=>e.name===t.src)).name:u[0].name,m=t.dest?u.find((e=>e.name===t.dest)).name:u[1].name,f=null===(o=u.find((e=>e.name===p)))||void 0===o?void 0:o.values,g=null===(n=u.find((e=>e.name===m)))||void 0===n?void 0:n.values;let h="";if(u.length>3){const e=[p,m,u[u.length-1].name],t=u.map((e=>e.name));h=t.filter((t=>!e.includes(t)))[0]}const y=Array.from([...new Set([...f,...g])]).map(((e,t)=>({id:t,name:e,sum:0,radius:0})));let b=f.map((e=>{const t=y.find((t=>t.name===e));return t?t.id:null})),v=g.map((e=>{const t=y.find((t=>t.name===e));return t?t.id:null})),S=b.map(((e,a)=>{var o,n;return{source:e,target:v[a],sum:null===(o=u.find((e=>e.name===u[u.length-1].name)))||void 0===o?void 0:o.values.buffer[a],strokeWidth:0,color:"",field:""===h?[h]:u.find((e=>e.name===h)).values.buffer[a],[t.colorConfigField]:null===(n=u.find((e=>e.name===t.colorConfigField)))||void 0===n?void 0:n.values.buffer[a],displayValue:`${u[u.length-1].display(u[u.length-1].values.buffer[a]).text}${void 0!==u[u.length-1].display(u[u.length-1].values.buffer[a]).suffix?u[u.length-1].display(u[u.length-1].values.buffer[a]).suffix:""}`}}));const x={};S.forEach((e=>{const{source:t,sum:a}=e;x[t]?x[t]+=a:x[t]=a}));const F=Object.keys(x).map((e=>({id:e,sum:x[e]})));S.forEach((function(e){const t=e.target;x[t]||(F.push({id:t,sum:1}),x[t]=1)})),y.map((function(e,t){e.sum=F[t].sum}));const C={nodeColor:a.visualization.getColorByName(t.nodeColor),linkColor:a.visualization.getColorByName(t.linkColor)},k=null===(r=t.arcRange)||void 0===r?void 0:r.split(",").map(Number)[0],E=null===(i=t.arcRange)||void 0===i?void 0:i.split(",").map(Number)[1],w=null===(l=t.NodeRange)||void 0===l?void 0:l.split(",").map(Number)[0],O=null===(s=t.NodeRange)||void 0===s?void 0:s.split(",").map(Number)[1],T=Number(Math.min(...S.map((e=>e.sum)))),N=Number(Math.max(...S.map((e=>e.sum)))),A=Number(Math.min(...y.map((e=>e.sum)))),M=Number(Math.max(...y.map((e=>e.sum))));let V=[];if("default"!==t.linkColorConfig&&t.colorConfigField){V=[...new Set(S.map((e=>e[t.colorConfigField])))].map((e=>({[t.colorConfigField]:e,color:""})));const e=function(e,t){const a=[],o=["#FFD700","#00BFFF","#FF8C00","#FF1493","#7FFF00","#9400D3","#00FFFF","#FF69B4","#32CD32","#FFDAB9"],n=["#7CFC00","#1E90FF","#FFA500","#FFC0CB","#8B008B","#32CD32","#FF00FF","#FF6347","#FFFF00","#FF1493"];for(let r=0;r<e;r++){const e=r%n.length;a.push(t?n[e]:o[e])}return a}(V.length,a.isDark);V.forEach(((t,a)=>{t.color=e[a]}))}S.forEach((e=>{c(t.arcFromSource,t.scale,t.arcThickness,e,k,E,T,N),"field"===t.linkColorConfig&&V?e.color=V.find((a=>a[t.colorConfigField]===e[t.colorConfigField])).color:e.color=C.linkColor})),y.forEach((e=>{t.radiusFromSource?"log"===t.scale?[...new Set(S.map((e=>e.source)))].includes(e.id)?e.radius=d(e.sum,w,O,A,M):e.radius=Math.max(...S.filter((t=>t.target===e.id)).map((e=>e.strokeWidth)))/2:[...new Set(S.map((e=>e.source)))].includes(e.id)?e.radius=e.sum/1e14:e.radius=Math.max(...S.filter((t=>t.target===e.id)).map((e=>e.strokeWidth)))/2:e.radius=t.nodeRadius}));const I=S.reduce(((e,a)=>{const o=e.find((e=>e.source===a.source&&e.target===a.target));return o?(o.sum+=a.sum,o.field.includes(a.field)||o.field.push(a.field)):e.push({source:a.source,target:a.target,sum:a.sum,displayValue:a.displayValue,strokeWidth:0,color:a.color,field:[a.field],[t.colorConfigField]:a[t.colorConfigField]}),e}),[]);return I.forEach((e=>{c(t.arcFromSource,t.scale,t.arcThickness,e,k,E,T,N)})),u.length>3&&(S=I),{uniqueNodes:y,links:S,hexColors:C,additionalField:h}}(n,p,g)}catch(e){console.error("parsing error: ",e)}if(console.log(m(v.uniqueNodes,v.links,r)>i),m(v.uniqueNodes,v.links,r)>i)return a().createElement("div",null,"Increase panels height to fit diagram");const S=g.colors.text.primary;return a().createElement("div",{style:f.panelContainerStyle},a().createElement(h,{textColor:S,parsedData:v,graphOptions:p,width:r,height:i,query:s,isDarkMode:g.isDark,panelId:l}),e.search&&a().createElement(y,{onQuery:u,nodeList:v.uniqueNodes,isDarkMode:g.isDark}))})).setPanelOptions((t=>{return t.addBooleanSwitch({path:"arcFromSource",name:"Arc thickness from source",defaultValue:!1,category:F}).addSliderInput({path:"arcThickness",name:"Arc thickness",defaultValue:1,settings:{min:1,max:15,step:1},showIf:e=>!e.arcFromSource,category:F}).addSliderInput({path:"arcOpacity",name:"Arc opacity",defaultValue:1,settings:{min:.1,max:1,step:.1},category:F}).addBooleanSwitch({path:"radiusFromSource",name:"Node radius from source",defaultValue:!1,category:F}).addSliderInput({path:"nodeRadius",name:"Node radius",defaultValue:5,settings:{min:5,max:15,step:1},showIf:e=>!e.radiusFromSource,category:F}).addSelect({path:"linkColorConfig",name:"Link color",description:"Select configuration for the link color",defaultValue:"default",category:F,settings:{allowCustomValue:!1,options:[{label:"Default",value:"default"},{label:"By field",value:"field"}]}}).addSelect({path:"colorConfigField",name:"Field",description:"Select a field to base the link color on:",category:F,settings:{allowCustomValue:!1,options:[],getOptions:(a=x((function*(t){const a=[];if(t&&t.data)for(const o of t.data)for(const n of o.fields){const r=(0,e.getFieldDisplayName)(n,o,t.data),i=r;a.push({value:i,label:r})}return Promise.resolve(a)})),function(e){return a.apply(this,arguments)})},showIf:e=>"default"!==e.linkColorConfig}).addColorPicker({path:"linkColor",name:"Link Color",defaultValue:"blue",showIf:e=>"default"===e.linkColorConfig,category:F}).addColorPicker({path:"nodeColor",name:"Node Color",defaultValue:"blue",category:F}).addBooleanSwitch({path:"search",name:"Activate search bar",defaultValue:!1,category:F}).addSelect({path:"scale",name:"Scaling",defaultValue:"lin",description:"Select the scaling of the diagram",settings:{allowCustomValue:!1,options:[{label:"Linear",value:"lin"},{label:"Logarithmic",value:"log"}]},showIf:e=>e.radiusFromSource||e.arcFromSource,category:C}).addCustomEditor({id:"setRange",path:"arcRange",editor:v,name:"Range for weighted links",description:"Range which the arc thickness is being mapped to",category:C,defaultValue:"1,15",showIf:e=>"log"===e.scale&&e.arcFromSource}).addCustomEditor({id:"setRange",path:"NodeRange",editor:v,name:"Range for weighted nodes",description:"Range which the node radius is being mapped to",category:C,defaultValue:"1,15",showIf:e=>"log"===e.scale&&e.radiusFromSource}).addSelect({path:"src",name:"Source",description:"Select the field to use as source:",category:C,settings:{allowCustomValue:!1,options:[],getOptions:function(){var t=x((function*(t){const a=[];if(t&&t.data)for(const o of t.data)for(const n of o.fields){const r=(0,e.getFieldDisplayName)(n,o,t.data),i=r;a.push({value:i,label:r})}return Promise.resolve(a)}));return function(e){return t.apply(this,arguments)}}()}}).addSelect({path:"dest",name:"Destination",description:"Select the field to use as target:",category:C,defaultValue:"",settings:{allowCustomValue:!1,options:[],getOptions:function(){var t=x((function*(t){const a=[];if(t&&t.data)for(const o of t.data)for(const n of o.fields){const r=(0,e.getFieldDisplayName)(n,o,t.data),i=r;a.push({value:i,label:r})}return Promise.resolve(a)}));return function(e){return t.apply(this,arguments)}}()}}).addTextInput({path:"toolTipSource",name:"Tooltip text",category:C,defaultValue:"From: ",description:"Text to be displayed infront of target node."}).addTextInput({path:"toolTipTarget",name:"Tooltip text",category:C,defaultValue:"To: ",description:"Text to be displayed infront of source node."}).addTextInput({path:"toolTipMetric",name:"Tooltip text",category:C,defaultValue:"Sum: ",description:"Text to be displayed infront of metric."});var a})).useFieldConfig({disableStandardOptions:[e.FieldConfigProperty.NoValue,e.FieldConfigProperty.Max,e.FieldConfigProperty.Min],standardOptions:{[e.FieldConfigProperty.Color]:{settings:{byValueSupport:!0,bySeriesSupport:!0,preferThresholdsMode:!0}}}})})(),l})()));
//# sourceMappingURL=module.js.map